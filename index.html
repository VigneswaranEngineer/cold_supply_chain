<!DOCTYPE html>
<html>
	<head><meta charset="utf-8">
		<title>IoT Sensor Data</title>
		<!-- Bootstrap CSS -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
		<!-- jQuery library -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<!-- Popper JS -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
		<!-- Bootstrap JS -->
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
		<!-- Thingspeak API -->
		<script src="https://cdn.thingspeak.com/apps/matlab_visualizations/thingSpeakMatlab.js"></script>


        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
        <meta name="viewport" content="width=device-width, initial-scale=1">
      
        <script src="https://code.jquery.com/jquery-3.6.0.js"
            integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>
      
      
        <!-- Bootstrap CSS -->
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css">
      

      <!-- Bootstrap CSS -->
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css">

      <!-- Bootstrap JS and jQuery -->
      <script src="https://code.jquery.com/jquery-3.6.0.slim.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.min.js"></script>
      
      
        <!-- polyfills -->
        <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
      
        <!-- Bootstrap CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
            integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
      
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js" crossorigin="anonymous"></script>
        <title>IoT Sensor Monitoring</title>
        <style>
            #map {
                height: 500px;
            }
        </style>
                
	</head>
	<body>
        <!-- Optional JavaScript; choose one of the two! -->
    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
    crossorigin="anonymous"></script>

<!-- Option 2: Separate Popper and Bootstrap JS -->
<!--
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js" integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>
-->


		<div class="container-fluid mt-3">
            <h1 class="text-center my-4">IoT Sensor Monitoring</h1>
			<ul class="nav nav-tabs">
				<li class="nav-item">
					<a class="nav-link active" data-toggle="tab" href="#sensorDataTab">Sensor Data</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-toggle="tab" href="#configurationTab">Configuration</a>
				</li>
        <li class="nav-item">
          <a class="nav-link" data-toggle="tab" href="#graph">Graph</a>
        </li>        
			</ul>
			<div class="tab-content">
				<div id="sensorDataTab" class="tab-pane fade show active">
					<div class="row mt-3">
						<div class="col-md-3">
							<div class="card border-primary">
								<div class="card-body">
									<h5 class="card-title">Temperature</h5>
									<p class="card-text">Value: <span id="sensor1Value"></span>°C</p>
								</div>
							</div>
						</div>
						<div class="col-md-3">
							<div class="card border-primary">
								<div class="card-body">
									<h5 class="card-title">Humidity</h5>
									<p class="card-text">Value: <span id="sensor2Value"></span></p>
								</div>
							</div>
						</div>
						<div class="col-md-3">
							<div class="card border-primary">
								<div class="card-body">
									<h5 class="card-title">GAS</h5>
									<p class="card-text">Value: <span id="sensor3Value"></span> ppm</p>
								</div>
							</div>
						</div>
						<div class="col-md-3">
							<div class="card border-primary">
								<div class="card-body">
									<h5 class="card-title">LDR</h5>
									<p class="card-text">Value: <span id="sensor4Value"></span> LUX</p>
								</div>
							</div>
						</div>
					</div>
				
                <div>

                <nav class="navbar navbar-expand-lg navbar-dark bg-dark mt-2">
                    <div class="container-fluid">
                        <a class="navbar-brand" href="#">GPS Data</a>
                    </div>
                  </nav>
                  <div class="card">
                    <div class="card-body">
                      <h2 class="card-title">Latitude</h2>
                      <p class="card-text"id="latitude-value">Locating...</p>
                    </div>
                  </div>
                  
                  <div class="card">
                    <div class="card-body">
                      <h2 class="card-title">Longitude</h2>
                      <p class="card-text"id="longitude-value">Locating...</p>
                    </div>
                  </div>
                
                    <div class="row mt-2">
                      <div class="col">
                          <div id="map"></div>
                          <script
                              src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDRnhz_ShC_KIc8_joDpaPr67QRr0YV3EQ&callback=initMap&v=weekly&channel=2"
                              async></script>
                      </div>
                    </div>
                    
                
                  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
                </div>
            </div>     

				<div id="configurationTab" class="tab-pane fade">
					<div class="row mt-3">
						<div class="col-md-6">
							<div class="card">
								<div class="card-body">
									<h5 class="card-title">Sensor 1 Thresholds</h5>
									<div class="form-group">
										<label for="sensor1LowThreshold">Low Threshold</label>
                                        <input type="number" class="form-control" id="sensor1LowThreshold" placeholder="Low Threshold">
									</div>
									<div class="form-group">
										<label for="sensor1HighThreshold">High Threshold</label>
										<input type="number" class="form-control" id="sensor1HighThreshold" placeholder="High Threshold">
									</div>
									<button class="btn btn-primary" onclick="setThresholds(1)">Set Thresholds</button>
									<div class="alert alert-danger mt-3" id="sensor1Alert" style="display:none;">Threshold Alert!</div>
								</div>
							</div>
						</div>
						<div class="col-md-6">
							<div class="card">
								<div class="card-body">
									<h5 class="card-title">Sensor 2 Thresholds</h5>
									<div class="form-group">
										<label for="sensor2LowThreshold">Low Threshold</label>
										<input type="number" class="form-control" id="sensor2LowThreshold" placeholder="Low Threshold">
									</div>
									<div class="form-group">
										<label for="sensor2HighThreshold">High Threshold</label>
										<input type="number" class="form-control" id="sensor2HighThreshold" placeholder="High Threshold">
									</div>
									<button class="btn btn-primary" onclick="setThresholds(2)">Set Thresholds</button>
									<div class="alert alert-danger mt-3" id="sensor2Alert" style="display:none;">Threshold Alert!</div>
								</div>
							</div>
						</div>
					</div>
					<div class="row mt-3">
						<div class="col-md-6">
							<div class="card">
								<div class="card-body">
									<h5 class="card-title">Sensor 3 Thresholds</h5>
									<div class="form-group">
										<label for="sensor3LowThreshold">Low Threshold</label>
										<input type="number" class="form-control" id="sensor3LowThreshold" placeholder="Low Threshold">
									</div>
									<div class="form-group">
										<label for="sensor3HighThreshold">High Threshold</label>
										<input type="number" class="form-control" id="sensor3HighThreshold" placeholder="High Threshold">
									</div>
									<button class="btn btn-primary" onclick="setThresholds(3)">Set Thresholds</button>
									<div class="alert alert-danger mt-3" id="sensor3Alert" style="display:none;">Threshold Alert!</div>
								</div>
							</div>
						</div>
						<div class="col-md-6">
							<div class="card">
								<div class="card-body">
									<h5 class="card-title">Sensor 4 Thresholds</h5>
									<div class="form-group">
										<label for="sensor4LowThreshold">Low Threshold</label>
										<input type="number" class="form-control" id="sensor4LowThreshold" placeholder="Low Threshold">
									</div>
									<div class="form-group">
										<label for="sensor4HighThreshold">High Threshold</label>
										<input type="number" class="form-control" id="sensor4HighThreshold" placeholder="High Threshold">
									</div>
									<button class="btn btn-primary" onclick="setThresholds(4)">Set Thresholds</button>
									<div class="alert alert-danger mt-3" id="sensor4Alert" style="display:none;">Threshold Alert!</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade show active" id="graph">
                  <canvas id="sensorGraph"></canvas>
                </div>
    
            </div>           
        </div>

            
        <!-- jQuery and Bootstrap JS -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

        <script>
            const host = "172.20.97.132:8090";
                  // const host = "localhost:8000";
                  const iconBase = "https://developers.google.com/maps/documentation/javascript/examples/full/images/";
                  const icon_src = "https://img.icons8.com/fluency/48/000000/marker-storm.png"
                  const icon_inactive = "https://img.icons8.com/sf-ultralight-filled/64/000000/marker-storm--v3.png"
                  let map;
                  let marker;
                  function initMap() {
      
      
                      const myLatLng = { lat: 12.9207392, lng: 80.2402497 };
                      map = new google.maps.Map(document.getElementById("map"), {
                          center: myLatLng,
                          zoom: 12,
                      });
                      marker = new google.maps.Marker({
                          position: myLatLng,
                          icon: icon_inactive,
                          //map,
                          title: JSON.stringify(myLatLng),
                      });
                      marker.setMap(map);
                  }
      
                  $(document).ready(function () {
      
                      loadDataOnIntial();
                      loadComSettings()
                      // monitoring section 
      
                      //const host = "167.233.7.5:8000"
                      const chatSocket = new WebSocket(
                          'ws://' + host + '/ws/app/notifications/'
                      );
                      chatSocket.onmessage = function (e) {
                          const data = JSON.parse(e.data);
                          var parsedMessage = data.message;
                          console.log(data.message);
      
                          // compile the template
                          var mytemplate = $('#SensorTemplate').html()
                          var template = Handlebars.compile(mytemplate);
                          var result = template(parsedMessage.sensor_data);
      
                          var gpstemplate = $('#GpsTemplate').html()
                          var template_gps = Handlebars.compile(gpstemplate);
                          var gps_result = template_gps(parsedMessage.gps_data);
      
                          var gastemplate = $('#GasTemplate').html()
                          var template_gas = Handlebars.compile(gastemplate);
                          var gas_result = template_gas(parsedMessage.gas_data);
      
                          $('#sensor_container').empty();
                          $('#sensor_container').append(result)
      
                          $('#gps_container').empty();
                          $('#gps_container').append(gps_result)
      
                          $('#gas_container').empty();
                          $('#gas_container').append(gas_result)
      
      
                          var parsedGpsData = parsedMessage.gps_data;
                          let location = { lat: parseFloat(parsedGpsData.latitude), lng: parseFloat(parsedGpsData.longitude) };
      
                          marker.setMap(null);
                          marker = new google.maps.Marker({
                              position: location,
                              icon: icon_src,
                              title: JSON.stringify(location),
                          });
                          marker.setMap(map);
                          map.setCenter(marker.getPosition())
      
      
                      };
                      chatSocket.onclose = function (e) {
                          console.error('Chat socket closed unexpectedly');
                      };
                  });

                  navigator.permissions.query({name:'geolocation'}).then(function(result) {
        if (result.state === 'granted') {
          // Update GPS values immediately
          navigator.geolocation.getCurrentPosition(function(position) {
            $('#latitude-value').text(position.coords.latitude.toFixed(4) + '° N');
            $('#longitude-value').text(position.coords.longitude.toFixed(4) + '° W');
          }, function() {
            $('#latitude-value').text('Unable to retrieve location.');
            $('#longitude-value').text('Unable to retrieve location.');
          });
        } else if (result.state === 'prompt') {
          // Ask for permission to use geolocation API
          navigator.geolocation.getCurrentPosition(function(position) {
            $('#latitude-value').text(position.coords.latitude.toFixed(4) + '° N');
            $('#longitude-value').text(position.coords.longitude.toFixed(4) + '° W');
          }, function() {
            $('#latitude-value').text('Unable to retrieve location.');
            $('#longitude-value').text('Unable to retrieve location.');
          });
        } else if (result.state === 'denied') {
          // Show error message if user denied permission to use geolocation API
          $('#latitude-value').text('Unable to retrieve location.');
          $('#longitude-value').text('Unable to retrieve location.');
        }
        // Listen for changes to the permission status
        result.onchange = function() {
          if (result.state === 'granted') {
            // Update GPS values when permission is granted
            navigator.geolocation.getCurrentPosition(function(position) {
              $('#latitude-value').text(position.coords.latitude.toFixed(4) + '° N');
              $('#longitude-value').text(position.coords.longitude.toFixed(4) + '° W');
            }, function() {
              $('#latitude-value').text('Unable to retrieve location.');
              $('#longitude-value').text('Unable to retrieve location.');
            });
          } else {
            // Show error message if permission is not granted
            $('#latitude-value').text('Unable to retrieve location.');
            $('#longitude-value').text('Unable to retrieve location.');
          }
        };
        });
      
        </script>
    
        <script type="text/javascript">
            // Thingspeak API Key and Channel ID
            var apiKey = "YE4TZ51GWFES0S6R";
            var channelId = "2349941";
    
            // Function to fetch Sensor Data from Thingspeak
            function fetchSensorData(sensor) {
                $.getJSON("https://api.thingspeak.com/channels/" + channelId + "/fields/" + sensor + ".json?results=2", function(data) {
                    var feeds = data.feeds;
                    var latestFeed = feeds[1];
                    var field = "field" + sensor;
                    var fieldValue = latestFeed[field];
                    var date = latestFeed.created_at;
    
                    $("#sensor" + sensor + "Value").text(fieldValue);
                    $("#sensor" + sensor + "Date").text(date);
    
                    // Check Thresholds
                    checkThresholds(sensor, fieldValue);
                });
            }
    
            // Function to check Thresholds
            function checkThresholds(sensor, value) {
                var lowThreshold = $("#sensor" + sensor + "LowThreshold").val();
                var highThreshold = $("#sensor" + sensor + "HighThreshold").val();
    
                if (value < lowThreshold || value > highThreshold) {
                    $("#sensor" + sensor + "Alert").show();
                    $("#sensor" + sensor + "Alert").text("Threshold Alert: Sensor " + sensor + " Value: " + value);
                } else {
                    $("#sensor" + sensor + "Alert").hide();
                }
            }
    
            // Function to set Thresholds
            function setThresholds(sensor) {
                var lowThreshold = $("#sensor" + sensor + "LowThreshold").val();
                var highThreshold = $("#sensor" + sensor + "HighThreshold").val();
    
                localStorage.setItem("sensor" + sensor + "LowThreshold", lowThreshold);
                localStorage.setItem("sensor" + sensor + "HighThreshold", highThreshold);
            }
    
            // Function to initialize Thresholds
            function initializeThresholds() {
                for (var i = 1; i <= 4; i++) {
                    var lowThreshold = localStorage.getItem("sensor" + i + "LowThreshold");
                    var highThreshold = localStorage.getItem("sensor" + i + "HighThreshold");
    
                    if (lowThreshold && highThreshold) {
                        $("#sensor" + i + "LowThreshold").val(lowThreshold);
                        $("#sensor" + i + "HighThreshold").val(highThreshold);
                    }
                }
            }
    
            // Function to initialize Sensor Data
            function initializeSensorData() {
                fetchSensorData(1);
                fetchSensorData(2);
                fetchSensorData(3);
                fetchSensorData(4);
            }
    
            $(document).ready(function() {
                initializeSensorData();
                initializeThresholds();
    
                // Fetch Sensor Data every 10 seconds
                setInterval(function() {
                    fetchSensorData(1);
                    fetchSensorData(2);
                    fetchSensorData(3);
                    fetchSensorData(4);
                }, 10000);

            });    

                		// On Threshold Change
		$(".threshold").on("change", function() {
			var sensor = $(this).data("sensor");
			setThresholds(sensor);
		});
	</script>
  
  <!-- jQuery and Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    $(document).ready(function() {
  // Fetch sensor data from ThingSpeak
  // Replace <YOUR_THINGSPEAK_API_KEY> with your actual ThingSpeak API key
  $.getJSON('https://api.thingspeak.com/channels/2349941/feeds.json?api_key=YE4TZ51GWFES0S6R&results=2', function(data) {
    var sensor1Data = [];
    var sensor2Data = [];
    var sensor3Data = [];
    var sensor4Data = [];
    var labels = [];

    // Extract data from the response
    for (var i = 0; i < data.feeds.length; i++) {
      var feed = data.feeds[i];
      var sensor1Value = parseFloat(feed.field1); // Assuming sensor 1 data is stored in field1
      var sensor2Value = parseFloat(feed.field2); // Assuming sensor 2 data is stored in field2
      var sensor3Value = parseFloat(feed.field3); // Assuming sensor 3 data is stored in field3
      var sensor4Value = parseFloat(feed.field4); // Assuming sensor 4 data is stored in field4

      sensor1Data.push(sensor1Value);
      sensor2Data.push(sensor2Value);
      sensor3Data.push(sensor3Value);
      sensor4Data.push(sensor4Value);

      // Generate time labels with a 5-minute interval
      var timestamp = new Date(feed.created_at);
      var minutes = timestamp.getMinutes();
      var roundedMinutes = Math.floor(minutes / 5) * 5; // Round down to the nearest multiple of 5
      timestamp.setMinutes(roundedMinutes, 0, 0);
      var label = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      labels.push(label);
    }

    // Create a chart using Chart.js
    var ctx = document.getElementById('sensorGraph').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Temperture(°C)',
            data: sensor1Data,
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
          },
          {
            label: 'Humidity(%)',
            data: sensor2Data,
            backgroundColor: 'rgba(192, 75, 192, 0.2)',
            borderColor: 'rgba(192, 75, 192, 1)',
            borderWidth: 1
          },
          {
            label: 'GAS(ppm)',
            data: sensor3Data,
            backgroundColor: 'rgba(192, 192, 75, 0.2)',
            borderColor: 'rgba(192, 192, 75, 1)',
            borderWidth: 1
          },
          {
            label: 'LDR(LUX)',
            data: sensor4Data,
            backgroundColor: 'rgba(75, 75, 192, 0.2)',
            borderColor: 'rgba(75, 75, 192, 1)',
            borderWidth: 1
          }
        ]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  });
});
// Function to add a new sensor to the sensor table
  </script>        

</body>
</html>